<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <title>SERVERTUC PANEL - Textos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="../static/img/favicon.svg">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <meta name="csrf-token" content="<%= it.csrfToken %>">
  <style>
    :root {
      --primary-color: #00bfff;
      --secondary-color: #87cefa;
      --dark-color: #2d3436;
      --light-color: #f5f6fa;
    }

    body {
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh;
      margin: 0;
      padding: 2rem;
    }

    .card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .btn {
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-dark {
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      color: #fff;
      border: none;
    }

    .btn-dark:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 191, 255, 0.4);
    }

    .btn-danger {
      border-radius: 8px;
    }

    .form-control {
      border-radius: 8px;
      border: 2px solid #e0e0e0;
      padding: 10px 15px;
      background-color: var(--light-color);
      color: var(--dark-color);
    }

    .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.2);
      background-color: #fff;
    }

    .__spinner {
      padding: 2rem;
    }

    .table-responsive {
      margin-top: 1rem;
    }

    .__preview {
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
      background-color: #f8f9fa;
    }

    .modal-content {
      border-radius: 15px;
      padding: 1rem;
    }

    .btn-responsive {
      border-radius: 8px;
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      color: #fff;
      border: none;
    }

    .btn-responsive:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 191, 255, 0.4);
    }

    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }
    }
  </style>
</head>

<body>
  <main class="d-flex">
    <%~ include("./sidebar", it) %>
    <div class="container-fluid p-0">
      <%~ include("./header", it) %>
      <div class="content pt-1 overflow-auto">
        <div class="card shadow border-0 overflow-auto p-3">
          <div class="d-md-flex justify-content-between mb-3 align-items-center">
            <h1 class="h3 text-gray-800">Textos</h1>
            <div class="d-flex gap-2 flex-wrap">
              <button class="btn btn-dark" onclick="exportAppText()"><i class="bi bi-download"></i> Exportar</button>
              <a class="btn btn-dark opacity-75"><i class="bi bi-upload"></i> Importar</a>
              <a class="btn btn-danger" id="reset_texts"><i class="bi bi-trash"></i> Reiniciar</a>
            </div>
          </div>

          <div class="input-group mb-3">
            <input type="search" class="form-control" id="search" placeholder="Buscar">
            <button class="input-group-text"><i class="bi bi-search"></i></button>
          </div>

          <div class="table-responsive text-center">
            <div class="d-flex justify-content-center align-items-center">
              <div class="__spinner">
                <div class="spinner-border text-light p-4 mb-3" role="status"><span class="visually-hidden">Loading...</span></div>
              </div>
            </div>
            <table class="table table-striped mb-3" id="table" style="display:none;">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Texto</th>
                  <th>Acción</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="../static/js/utils.js"></script>
  <script>
    // Aquí tu JS existente para carga, edición, reset y filtros de textos
    // Se mantiene igual, solo se adaptan clases y estilos
  </script>
</body>

</html>                  </div>
                  <div class="mb-3 d-flex justify-content-center">
                    <div class="form-check me-3">
                      <input class="form-check-input __bold" type="checkbox">
                      <label class="form-check-label">Negrita</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input __italic" type="checkbox">
                      <label class="form-check-label">Itálica</label>
                    </div>
                  </div>
                  <div class="modal-footer p-0 pt-2">
                    <div class="d-flex flex-fill justify-content-end">
                      <botton type="button" class="btn-responsive w-100 me-2 __apply_color">
                        COLOR
                      </botton>
                      <button type="button" class="btn-responsive w-100 me-2" data-bs-dismiss="modal">Cerrar</button>
                      <button type="button" class="btn-responsive w-100" data-bs-dismiss="modal" id="btnSave">Guardar</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="../static/js/sidebar.js"></script>
  <script src="../static/js/utils.js"></script>
  <script src="../static/js/jscolor.js"></script>

  <script type="module" src="../static/js/picker.js"></script>
  <script>
    let rows;
    let csrfToken = getCsrfTokenHead();

    const spinner = document.querySelector('.__spinner');
    const table = document.querySelector('#table');

    const showSpinner = () => {
      spinner.style.display = 'block';
      table.style.display = 'none';
    }
    const closeSpinner = () => {
      spinner.style.display = 'none';
      table.style.display = 'block';
    };

    const loadTextList = async () => {
      try {

        showSpinner();

        const table = document.getElementById('table').getElementsByTagName('tbody')[0];
        const response = await fetch('/texts_list', {
          method: 'GET',
          headers: {}
        });

        const data = await response.json();

        if (data.data.length > 0) {

          $('#table > tbody > tr').remove();
          data.data.forEach((value) => {

            const json = JSON.stringify({
              id: value.label,
              label: value.label,
              text: value.text,
              user_id: data.user_id
            });

            let action = '';
            action += `<input type="hidden" id="text_${value.label}" value="${encodeURIComponent(json)}"><tr>`;
            action += `<div class="d-md-flex justify-content-center align-items-center">`;
            action += `<button class="btn btn-sm btn-dark mb-1 me-1" data-bs-toggle="modal" data-bs-target="#modal-text" data-bs-text-id="${value.label}">`;
            action += `<i class="bi bi-pencil-square"></i></button>`;
            action += `<a class="btn btn-sm btn-dark mb-1 me-1">`
            action += `<i class="bi bi-trash" onclick='resetText("${value.label}");'></i></a>`;
            action += `<button class="btn btn-sm btn-dark mb-1 me-1" onclick="copyText('${value.text}')">`;
            action += `<i class="bi bi-clipboard"></i></button>`;
            action += `</div>`;

            const row = table.insertRow();
            row.insertCell(0).textContent = value.id;
            row.insertCell(1).textContent = value.text;
            row.insertCell(2).innerHTML = action;

          });

          rows = $('#table > tbody > tr');
        }

      } catch (err) {
        showToastError('No puedo recibir mensajes de texto')
      } finally {
        closeSpinner();
      }
    }

    loadTextList();

    const buttonSave = document.getElementById("btnSave");
    buttonSave.addEventListener('click', async e => {

      const id = document.getElementById("id").value;
      const text = document.getElementById("text").value;

      try {

        const response = await fetch('/texts/update', {
          method: 'PUT',
          body: JSON.stringify({
            label: id,
            text
          }),
          headers: {
            'Content-Type': 'application/json',
          }
        });

        if (response.status == 200) {
          showToastSuccess('Texto actualizado exitosamente!')
          setTimeout(() => loadTextList(), 1000);
          return;
        }
        const data = await response.json();
        if (data.message) {
          showToastError(data.message);
        }

      } catch (err) {
        showToastError('No se puede actualizar el texto')
      }
    });

    const resetTexts = document.getElementById("reset_texts");
    resetTexts.addEventListener('click', e => {
      showAlertConfirm(async () => {
        try {

          const response = await fetch('/texts/reset', {
            method: 'DELETE',
            headers: {},
          });

          if (response.status === 204) {
            showToastSuccess('Éxito, todos los textos reiniciados!');
            setTimeout(() => loadTextList(), 1000);
            return
          }

          const data = await response.json();
          if (data.message) {
            showToastError(data.message);
          }

        } catch (e) {
          showToastError("¡No se pueden restablecer los mensajes de texto!");
        }
      })
    });

    const resetText = async (label) => {
      try {

        const response = await fetch('/text/reset', {
          method: 'PUT',
          body: JSON.stringify({
            label
          }),
          headers: {
            'Content-Type': 'application/json'
          },
        });

        if (response.status === 200) {
          showToastSuccess(`Éxito, ${label} reseteado!`);
          setTimeout(() => loadTextList(), 1000);
          return;
        }

        const data = await response.json();
        if (data.message) {
          showToastError(data.message);
        }

      } catch (err) {
        showToastError(`No se puede restablecer ${label}`);
      }
    }

    const getColorFromFont = (text) => {
      const pattern = /<font color="(.*)">(.*)<\/font>/g;
      const result = pattern.exec(text);
      if (result) {
        return result[1];
      }
      return null;
    }

    const replaceTextColor = (text, color) => {
      const pattern = /<font color="(.*)">(.*)<\/font>/g;
      if (!pattern.exec(text)) {
        return `<font color="${color}">${text}</font>`;
      }
      const result = text.replace(pattern, `<font color="${color}">$2</font>`);
      return result;
    }

    const setTextBold = (text) => {
      const pattern = /<b>(.*)<\/b>/g;
      if (text.match(pattern)) {
        const result = text.replace(pattern, `$1`);
        return result;
      }
      return `<b>${text}</b>`;
    }

    const setTextItalic = (text) => {
      const pattern = /<i>(.*)<\/i>/g;
      if (text.match(pattern)) {
        const result = text.replace(pattern, `$1`);
        return result;
      }
      return `<i>${text}</i>`;
    }

    const setPreview = (text) => {
      const preview = document.querySelector('.__preview');
      preview.innerHTML = text;
    }

    const applyColor = document.querySelector('.__apply_color');
    applyColor.addEventListener('click', () => {
      const div = document.createElement('div');
      const color = new jscolor(div);
      color.onInput = () => {
        const text = document.querySelector('#text');
        text.value = replaceTextColor(text.value, color.toHEXString());
        setPreview(text.value);
      }
      color.onClose = () => div.remove();
      applyColor.insertAdjacentElement('beforebegin', div);

      const c = getColorFromFont(text.value);
      if (c) color.fromString(c);
      color.show();
    })

    const bold = document.querySelector('.__bold');
    bold.addEventListener('click', () => {
      const text = document.querySelector('#text');
      text.value = setTextBold(text.value);
      setPreview(text.value);
    })

    const italic = document.querySelector('.__italic');
    italic.addEventListener('click', () => {
      const text = document.querySelector('#text');
      text.value = setTextItalic(text.value);
      setPreview(text.value);
    })

    $(document).ready(function() {
      $('#modal-text').on('show.bs.modal', function(event) {

        const text_id = event.relatedTarget.getAttribute('data-bs-text-id')
        const text = JSON.parse(decodeURIComponent($('#text_' + text_id).val()))
        const div = $('#modal-text div')

        $('#id').attr('value', text_id)

        bold.checked = text.text.match(/<b>(.*)<\/b>/g) ? true : false;
        italic.checked = text.text.match(/<i>(.*)<\/i>/g) ? true : false;

        div.find('input[name="label"]').val(text.label)
        div.find('textarea[name="text"]').val(text.text)
        div.find('.__preview').html(text.text)
      });
    });

    $('#search').on('input', function() {
      const val = $.trim($(this).val()).replace(/ +/g, ' ').toLowerCase();
      rows.show().filter(function() {
        const text = $(this).text().replace(/\s+/g, ' ').toLowerCase();
        return !~text.indexOf(val);
      }).hide();
    })

    function exportAppText() {
      //
    }

    function copyText(text) {
      var $temp = $("<input>");
      $("body").append($temp);
      $temp.val(text).select();
      document.execCommand("copy");
      $temp.remove();
    }
  </script>
</body>

</html>
